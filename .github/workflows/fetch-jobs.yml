name: Fetch All Jobs

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - '.github/scripts/**'

# Prevent concurrent runs
concurrency:
  group: job-fetch
  cancel-in-progress: false

jobs:
  fetch-all:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}
        fetch-depth: 0  # Full history for proper rebasing

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install axios

    - name: Create logs directory
      run: mkdir -p .github/logs

    - name: Fetch jobs from all sources
      run: node .github/scripts/index.js 2>&1 | tee .github/logs/fetch.log
      env:
        JSEARCH_API_KEY: ${{ secrets.JSEARCH_API_KEY }}

    - name: Display logs (always run)
      if: always()
      run: |
        echo "ğŸ“‹ Fetch Output (last 50 lines):"
        tail -50 .github/logs/fetch.log || echo "Log file not found"

    - name: Verify output files
      if: always()
      run: |
        echo "ğŸ“Š Output Files:"
        ls -lh .github/data/jobs-shared.json || echo "jobs-shared.json not found"
        ls -lh .github/data/jobs-metadata.json || echo "jobs-metadata.json not found"
        ls -lh .github/data/dedupe-store.json || echo "dedupe-store.json not found"

    - name: Display job counts
      if: always()
      run: |
        if [ -f ".github/data/jobs-metadata.json" ]; then
          echo "ğŸ“Š Job Statistics:"
          cat .github/data/jobs-metadata.json | jq '{
            total_jobs,
            unique_jobs,
            duplicates_removed,
            by_job_type,
            jsearch_stats
          }'
        fi

    - name: Show git status
      if: always()
      run: |
        echo "ğŸ“ Git Status:"
        git status

    - name: Show git diff (if changes)
      if: always()
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ Git Diff:"
          git diff --stat
        fi

    - name: ğŸ”„ Pull latest changes (before push)
      if: always()
      run: |
        echo "ğŸ“¥ Pulling latest changes..."
        git fetch origin ${{ github.ref_name }}
        # Use rebase instead of reset to preserve local commits
        if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/${{ github.ref_name }})" ]; then
          git pull origin ${{ github.ref_name }} --rebase || echo "No divergent commits to rebase"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Push changes
      if: always()
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“¤ Pushing changes to origin..."
          git push origin ${{ github.ref_name }}
        else
          echo "â„¹ï¸ No changes to push"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Workflow failed - check logs above"
        echo "Last 30 lines of fetch log:"
        tail -30 .github/logs/fetch.log || echo "No log file"
