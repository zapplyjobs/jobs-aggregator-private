name: Fetch All Jobs

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 min (288 req/day ‚Äî QUERIES_PER_RUN=3)
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/scripts/**'

# Prevent concurrent runs
concurrency:
  group: job-fetch
  cancel-in-progress: false

jobs:
  fetch-all:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}
        fetch-depth: 0  # Full history for proper rebasing
        submodules: recursive
        token: ${{ secrets.GH_PAT }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm ci

    - name: Create logs directory
      run: mkdir -p .github/logs .github/data

    - name: Seed all_jobs.json from jobs-data-2026
      run: |
        echo "üì• Seeding previous all_jobs.json from jobs-data-2026..."
        curl -sf "https://raw.githubusercontent.com/zapplyjobs/jobs-data-2026/main/.github/data/all_jobs.json?t=$(date +%s)" \
          -o .github/data/all_jobs.json && \
          echo "‚úÖ Seeded $(wc -l < .github/data/all_jobs.json) jobs from jobs-data-2026" || \
          echo "‚ö†Ô∏è Could not seed all_jobs.json ‚Äî starting fresh"

    - name: Fetch jobs from all sources
      run: node .github/scripts/index.js 2>&1 | tee .github/logs/fetch.log
      env:
        JSEARCH_API_KEY: ${{ secrets.JSEARCH_API_KEY }}

    - name: Display logs (always run)
      if: always()
      run: |
        echo "üìã Fetch Output (last 50 lines):"
        tail -50 .github/logs/fetch.log || echo "Log file not found"

    - name: Verify output files
      if: always()
      run: |
        echo "üìä Output Files:"
        ls -lh .github/data/all_jobs.json || echo "all_jobs.json not found"
        ls -lh .github/data/jobs-metadata.json || echo "jobs-metadata.json not found"
        ls -lh .github/data/dedupe-store.json || echo "dedupe-store.json not found"

    - name: Display job counts
      if: always()
      run: |
        if [ -f ".github/data/jobs-metadata.json" ]; then
          echo "üìä Job Statistics:"
          cat .github/data/jobs-metadata.json | jq '{
            total_jobs,
            unique_jobs,
            duplicates_removed,
            by_job_type,
            jsearch_stats
          }'
        fi

    - name: Show git status
      if: always()
      run: |
        echo "üìù Git Status:"
        git status

    - name: Show git diff (if changes)
      if: always()
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "üìù Git Diff:"
          git diff --stat
        fi

    - name: üîÑ Pull latest changes (before push)
      if: always()
      run: |
        echo "üì• Pulling latest changes..."
        git fetch origin ${{ github.ref_name }}
        # Use rebase instead of reset to preserve local commits
        if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/${{ github.ref_name }})" ]; then
          git pull origin ${{ github.ref_name }} --rebase || echo "No divergent commits to rebase"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Push changes
      if: always()
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "üì§ Pushing changes to origin..."
          git push origin ${{ github.ref_name }}
        else
          echo "‚ÑπÔ∏è No changes to push"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Push all_jobs.json to jobs-data-2026
      if: success()
      run: |
        echo "üì§ Pushing all_jobs.json to jobs-data-2026..."

        # Clone jobs-data-2026 into a temp directory
        git clone "https://x-access-token:${GH_PAT}@github.com/zapplyjobs/jobs-data-2026.git" /tmp/jobs-data-2026

        # Copy all_jobs.json and jobs-metadata.json
        cp .github/data/all_jobs.json /tmp/jobs-data-2026/.github/data/all_jobs.json
        cp .github/data/jobs-metadata.json /tmp/jobs-data-2026/.github/data/jobs-metadata.json

        # Commit and push
        cd /tmp/jobs-data-2026
        git config user.email "bot@zapplyjobs.com"
        git config user.name "Data Bot"
        git add .github/data/all_jobs.json .github/data/jobs-metadata.json

        if [ -n "$(git status --porcelain)" ]; then
          JOB_COUNT=$(wc -l < .github/data/all_jobs.json)
          git commit -m "Update jobs - $(date -u +%Y-%m-%d) - ${JOB_COUNT} jobs"
          git push origin main
          echo "‚úÖ Pushed ${JOB_COUNT} jobs to jobs-data-2026"
        else
          echo "‚ÑπÔ∏è No changes to push (all_jobs.json unchanged)"
        fi
      env:
        GH_PAT: ${{ secrets.GH_PAT }}

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Workflow failed - check logs above"
        echo "Last 30 lines of fetch log:"
        tail -30 .github/logs/fetch.log || echo "No log file"
