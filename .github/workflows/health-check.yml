name: Health Check

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check aggregator status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Aggregator Health Check ==="
          echo "Checking recent workflow runs..."

          # Check last 5 runs of post-to-discord workflow
          RUNS=$(gh run list --workflow=post-to-discord.yml --limit 5 --json databaseId,conclusion,createdAt,displayTitle --jq '.[] | "\(.databaseId) | \(.conclusion) | \(.createdAt)"' || echo "No runs yet")

          if [ -z "$RUNS" ]; then
            echo "⚠️ No post-to-discord workflow runs found (workflow not created yet)"
            echo "✅ Health check passed - no failures to detect"
            exit 0
          fi

          echo "$RUNS"
          echo ""

          # Check if last run failed
          LAST_RUN=$(gh run list --workflow=post-to-discord.yml --limit 1 --json conclusion --jq '.[0].conclusion' 2>/dev/null || echo "none")

          if [ "$LAST_RUN" = "failure" ]; then
            echo "❌ Last aggregator run FAILED!"
            echo "Check logs: gh run view --log"
            exit 1
          fi

          echo "✅ Health check passed"
